<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced IELTS Flashcards</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    #controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 8px 14px; cursor: pointer; }
    #flashcard { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
    #word { font-size: 2rem; font-weight: bold; cursor: pointer; }
    .hidden { display: none; }
    #filters { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Enhanced IELTS Flashcards</h1>

  <div id="controls">
    <button onclick="prevCard()">Previous</button>
    <button onclick="nextCard()">Next</button>
    <button onclick="shuffleCards()">Shuffle</button>
    <!-- button onclick="toggleQuizMode()">Quiz Mode</button -->
  </div>

  <div id="filters">
    <input type="text" id="search" placeholder="Search..." oninput="applyFilters()" />
    <select id="bandFilter" onchange="applyFilters()">
      <option value="">All Bands</option>
    </select>
    <select id="posFilter" onchange="applyFilters()">
      <option value="">All POS</option>
    </select>
  </div>

  <div id="flashcard">
    <div id="word" onclick="toggleInfo()"></div>
    <div id="definition" class="hidden"></div>
    <div id="example" class="hidden"></div>
    <div id="progress"></div>
  </div>

  <div style="margin-top:20px; text-align:center;">
    <button onclick="rateCard(5)">Easy</button>
    <button onclick="rateCard(3)">Medium</button>
    <button onclick="rateCard(1)">Hard</button>
  </div>

<script>
  // CACHE-BUSTING URL to always fetch latest CSV
  const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbYZwC-HcUDJK0JVkW4SC8j0DLDtVnCsR8uTmE_z3iSS8H9i9lmt5jB8FMVSVjQ_SDj_N56H-PfCtz/pub?gid=0&single=true&output=csv&t=" + new Date().getTime();

  let cards = [];
  let filteredCards = [];
  let index = 0;
  //let quizMode = false;

  // SM-2 spaced repetition data
  let sm2Data = JSON.parse(localStorage.getItem("sm2Data") || "{}");

  async function loadCSV() {
    const res = await fetch(csvURL);
    const text = await res.text();
    const rows = text.split(/\r?\n/).map(r => r.split(","));
    const header = rows.shift();

    cards = rows.map(r => Object.fromEntries(header.map((h,i) => [h.trim(), r[i]])));
    filteredCards = [...cards];

    populateFilters();
    loadProgress();
    showCard();
  }

  function populateFilters() {
    const bandSet = new Set(cards.map(c => c.Band_Level));
    const posSet = new Set(cards.map(c => c.POS));

    const bandFilter = document.getElementById("bandFilter");
    const posFilter = document.getElementById("posFilter");

    bandSet.forEach(b => {
      if (!Array.from(bandFilter.options).some(o => o.value === b)) {
        bandFilter.innerHTML += `<option value="${b}">${b}</option>`;
      }
    });
    posSet.forEach(p => {
      if (!Array.from(posFilter.options).some(o => o.value === p)) {
        posFilter.innerHTML += `<option value="${p}">${p}</option>`;
      }
    });
  }

  function showCard() {
    const card = filteredCards[index];
    if (!card) return;

    document.getElementById('word').textContent = card.Word;
    document.getElementById('definition').textContent = "Definition: " + card.Definition;
    document.getElementById('example').textContent = "Example: " + card.Example_Sentence;

    document.getElementById('definition').classList.add('hidden');
    document.getElementById('example').classList.add('hidden');

    speak(card.Word);
    updateProgress();
  }

  function toggleInfo() {
    document.getElementById('definition').classList.toggle('hidden');
    document.getElementById('example').classList.toggle('hidden');
  }

  function nextCard() {
    index = (index + 1) % filteredCards.length;
    saveProgress();
    showCard();
  }

  function prevCard() {
    index = (index - 1 + filteredCards.length) % filteredCards.length;
    saveProgress();
    showCard();
  }

  function shuffleCards() {
    filteredCards.sort(() => Math.random() - 0.5);
    index = 0;
    saveProgress();
    showCard();
  }

  function applyFilters() {
    const search = document.getElementById("search").value.toLowerCase();
    const band = document.getElementById("bandFilter").value;
    const pos = document.getElementById("posFilter").value;

    filteredCards = cards.filter(card =>
      (!band || card.Band_Level === band) &&
      (!pos || card.POS === pos) &&
      (card.Word.toLowerCase().includes(search) || card.Definition.toLowerCase().includes(search))
    );

    index = 0;
    showCard();
  }

  function updateProgress() {
    document.getElementById("progress").textContent = `Card ${index+1} / ${filteredCards.length}`;
  }

  function saveProgress() {
    localStorage.setItem("flashcardIndex", index);
  }

  function loadProgress() {
    index = Number(localStorage.getItem("flashcardIndex")) || 0;
  }

  function speak(text) {
    const utt = new SpeechSynthesisUtterance(text);
    speechSynthesis.cancel();
    speechSynthesis.speak(utt);
  }

  //function toggleQuizMode() {
  //  quizMode = !quizMode;
  //  alert("Quiz Mode " + (quizMode ? "ON" : "OFF"));
  //}

  function rateCard(quality) {
    const card = filteredCards[index];
    const key = card.Word;
    if (!sm2Data[key]) sm2Data[key] = { ef: 2.5, interval: 1, reps: 0, next: Date.now() };

    const d = sm2Data[key];
    d.reps++;
    d.ef = Math.max(1.3, d.ef + (0.1 - (5-quality) * (0.08 + (5-quality)*0.02)));

    if (quality < 3) {
      d.reps = 0;
      d.interval = 1;
    } else {
      if (d.reps === 1) d.interval = 1;
      else if (d.reps === 2) d.interval = 6;
      else d.interval = Math.round(d.interval * d.ef);
    }

    d.next = Date.now() + d.interval * 86400000;
    localStorage.setItem("sm2Data", JSON.stringify(sm2Data));
    nextCard();
  }

  loadCSV();
</script>
</body>
</html>
