<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flashcards</title>
<style>
body { font-family: sans-serif; padding: 20px; background:#f7f7f7; }
#flashcard { cursor:pointer; border:1px solid #ccc; padding:40px; width:350px; text-align:center; font-size:24px; margin-bottom:10px; background:#fff; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.2);}
#controls { margin-bottom:20px; }
button, select, input { margin:5px; padding:5px 10px; font-size:16px; }
#feedback { margin-top:10px; font-size:18px; }
.hidden { display:none; }
</style>
</head>
<body>

<h2>Flashcards</h2>

<!-- Controls: search, filters, navigation -->
<div id="controls">
  <input type="text" id="search" placeholder="Search word" oninput="applyFilters()">
  <select id="bandFilter" onchange="applyFilters()"><option value="">All Bands</option></select>
  <select id="posFilter" onchange="applyFilters()"><option value="">All POS</option></select>
  <button onclick="shuffleCards()">Shuffle</button>
  <button onclick="prevCard()">Previous</button>
  <button onclick="nextCard()">Next</button>
  <button onclick="toggleQuizMode()">Toggle Quiz Mode</button>
</div>

<!-- Flashcard -->
<div id="flashcard">Loading...</div>

<!-- Quiz input and feedback -->
<div id="quizContainer">
  <input id="quizInput" class="hidden" placeholder="Type your answer and press Enter" onkeydown="handleQuiz(event)">
  <div id="feedback"></div>
</div>

<!-- Progress display -->
<div id="progress"></div>

<script>
// Google Sheet CSV URL
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbYZwC-HcUDJK0JVkW4SC8j0DLDtVnCsR8uTmE_z3iSS8H9i9lmt5jB8FMVSVjQ_SDj_N56H-PfCtz/pub?gid=0&single=true&output=csv&t=" + new Date().getTime();

let cards = [];
let filteredCards = [];
let index = 0;
let quizMode = false;
let sm2Data = JSON.parse(localStorage.getItem("sm2Data")|| "{}");

// Your backend URL
const backendURL = "https://flashcard-backend-psi.vercel.app/check-answer";

// Load CSV
async function loadCSV(){
  const res = await fetch(csvURL);
  const text = await res.text();
  cards = parseCSV(text);
  filteredCards = [...cards];
  populateFilters();
  loadProgress();
  showCard();
}

// CSV parser
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  const headers = lines.shift().split(",");
  return lines.map(line=>{
    const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
    const matches = line.match(regex);
    return Object.fromEntries(headers.map((h,i)=>[h.trim(), matches[i]?matches[i].replace(/^"|"$/g,""):""]));
  });
}

// Filters
function populateFilters(){
  const bandSet = new Set(cards.map(c=>c.Band_Level));
  const posSet = new Set(cards.map(c=>c.POS));
  const bandFilter = document.getElementById("bandFilter");
  const posFilter = document.getElementById("posFilter");
  bandSet.forEach(b=>{ if (![...bandFilter.options].some(o=>o.value===b)) bandFilter.innerHTML+=`<option value="${b}">${b}</option>`;});
  posSet.forEach(p=>{ if (![...posFilter.options].some(o=>o.value===p)) posFilter.innerHTML+=`<option value="${p}">${p}</option>`;});
}

function applyFilters(){
  const search = document.getElementById("search").value.toLowerCase();
  const band = document.getElementById("bandFilter").value;
  const pos = document.getElementById("posFilter").value;
  filteredCards = cards.filter(card=>
    (!band||card.Band_Level===band)&&
    (!pos||card.POS===pos)&&
    (card.Word.toLowerCase().includes(search)||
    (card.Definition && card.Definition.toLowerCase().includes(search))||
    (card.Example_Sentence && card.Example_Sentence.toLowerCase().includes(search)))
  );
  index=0; showCard();
}

// Show card
function showCard(){
  if(filteredCards.length===0) return;
  const card = filteredCards[index];
  const flashcard = document.getElementById("flashcard");
  flashcard.textContent = card.Word;

  // Pronounce
  speak(card.Word);

  flashcard.replaceWith(flashcard.cloneNode(true));
  const newCard = document.getElementById("flashcard");
  newCard.addEventListener("click",()=>{
    if(quizMode) return;
    if(newCard.textContent===card.Word){
      newCard.innerHTML = `<strong>${card.Definition}</strong><br><em>${card.Example_Sentence}</em>`;
    } else {
      newCard.textContent = card.Word;
      speak(card.Word);
    }
  });

  document.getElementById("quizInput").classList.toggle("hidden", !quizMode);
  document.getElementById("quizInput").value="";
  document.getElementById("feedback").textContent="";
  updateProgress();
}

// Next / Previous / Shuffle
function nextCard(){ index=(index+1)%filteredCards.length; saveProgress(); showCard(); }
function prevCard(){ index=(index-1+filteredCards.length)%filteredCards.length; saveProgress(); showCard(); }
function shuffleCards(){ filteredCards.sort(()=>Math.random()-0.5); index=0; saveProgress(); showCard(); }

// Progress / LocalStorage
function updateProgress(){ document.getElementById("progress").textContent=`Card ${index+1} / ${filteredCards.length}`; }
function saveProgress(){ localStorage.setItem("flashcardIndex", index); }
function loadProgress(){ index=Number(localStorage.getItem("flashcardIndex"))||0; }

// Speech
function speak(text){ const u = new SpeechSynthesisUtterance(text); u.lang="en-US"; speechSynthesis.cancel(); speechSynthesis.speak(u); }

// Toggle Quiz Mode
function toggleQuizMode(){ quizMode=!quizMode; showCard(); alert("Quiz Mode "+(quizMode?"ON":"OFF")); }

// AI-powered Quiz Check
async function handleQuiz(event){
  if(event.key!=="Enter") return;
  const card = filteredCards[index];
  const userInput = event.target.value.trim();
  document.getElementById("feedback").textContent="Checking...";
  try{
    const resp = await fetch(backendURL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({userAnswer:userInput, correctAnswer:card.Definition})
    });
    const data = await resp.json();
    const feedback = document.getElementById("feedback");
    if(data.correct){
      feedback.textContent="✅ Correct!";
      rateCard(5);
    } else {
      feedback.textContent=`❌ Incorrect. Correct: ${card.Definition}`;
      rateCard(2);
    }
    setTimeout(nextCard,1500);
  } catch(err){
    document.getElementById("feedback").textContent="Error checking answer.";
    console.error(err);
  }
}

// SM-2 spaced repetition
function rateCard(quality){
  const card = filteredCards[index];
  const key = card.Word;
  if(!sm2Data[key]) sm2Data[key]={ef:2.5,interval:1,reps:0,next:Date.now()};
  const d = sm2Data[key];
  d.reps++;
  d.ef = Math.max(1.3,d.ef + (0.1-(5-quality)*(0.08+(5-quality)*0.02)));
  if(quality<3){ d.reps=0; d.interval=1; }
  else if(d.reps===1) d.interval=1;
  else if(d.reps===2) d.interval=6;
  else d.interval=Math.round(d.interval*d.ef);
  d.next = Date.no
